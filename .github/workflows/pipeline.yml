---
name: IaC Pipeline

"on":
  workflow_dispatch:
    inputs:
      deploy_env:
        description: "Environment to deploy"
        required: true
        default: "dev"

jobs:
  deploy:
    runs-on: self-hosted

    environment:
      name: dev

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate to Vault
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: oidc
          role: github-actions

      - name: Fetch secrets from Vault
        run: |
          DB_PASSWORD=$(
            vault kv get \
              -field=password \
              secret/${{ github.event.inputs.deploy_env }}/db
          )
          echo "DB_PASSWORD=$DB_PASSWORD" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            terraform \
            vagrant \
            ansible \
            docker.io \
            virtualbox
          sudo systemctl enable --now docker

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Verify Docker container
        run: |
          vagrant ssh vm -c "docker ps"

      - name: Terraform Destroy
        if: "always()"
        working-directory: terraform
        run: terraform destroy -auto-approve
