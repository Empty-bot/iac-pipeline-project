name: IaC Pipeline AWS

on:
  workflow_dispatch:
    inputs:
      deploy_env:
        description: "Environment to deploy"
        required: true
        default: "production"

jobs:
  # ==========================================
  # JOB 1 : PROVISION INFRASTRUCTURE
  # ==========================================
  provision:
    runs-on: ubuntu-latest

    environment:
      name: production

    permissions:
      id-token: write
      contents: read

    outputs:
      instance_ip: ${{ steps.terraform.outputs.instance_ip }}
      ssh_key_path: ${{ steps.terraform.outputs.ssh_key_path }}

    env:
      VAULT_ADDR: ${{ vars.VAULT_ADDR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------------
      # Authenticate to Vault using GitHub OIDC
      # -------------------------
      - name: Login to Vault with OIDC
        run: |
          sudo apt install -y jq curl

          echo "ðŸ” VAULT_ADDR = $VAULT_ADDR"
          echo "ðŸ” Repository = ${{ github.repository }}"

          # RÃ©cupÃ©rer le JWT token de GitHub
          JWT=$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/${{ github.repository_owner }}" \
            | jq -r '.value')

          echo "JWT token obtained (length: ${#JWT})"

          # S'authentifier Ã  Vault avec le JWT (namespace admin pour HCP Vault)
          VAULT_RESPONSE=$(curl -s \
            --request POST \
            --header "X-Vault-Namespace: admin" \
            --data "{\"jwt\":\"$JWT\",\"role\":\"github-actions\"}" \
            $VAULT_ADDR/v1/auth/jwt/login)

          VAULT_TOKEN=$(echo "$VAULT_RESPONSE" | jq -r '.auth.client_token')

          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "XXX Failed to authenticate to Vault"
            echo "Response: $(echo $VAULT_RESPONSE | jq '.')"
            exit 1
          fi

          echo "VVV Vault authentication successful"
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
          echo "VAULT_NAMESPACE=admin" >> $GITHUB_ENV

      # -------------------------
      # Read AWS secrets from Vault
      # -------------------------
      - name: Read AWS credentials from Vault
        run: |
          echo "Reading AWS credentials from Vault..."

          AWS_CREDS=$(curl -s \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "X-Vault-Namespace: $VAULT_NAMESPACE" \
            $VAULT_ADDR/v1/secret/data/iac/aws)

          AWS_ACCESS_KEY_ID=$(echo $AWS_CREDS | jq -r '.data.data.access_key_id')
          AWS_SECRET_ACCESS_KEY=$(echo $AWS_CREDS | jq -r '.data.data.secret_access_key')
          AWS_REGION=$(echo $AWS_CREDS | jq -r '.data.data.region')

          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ "$AWS_ACCESS_KEY_ID" = "null" ]; then
            echo "XXX Failed to read AWS credentials from Vault"
            echo "Response: $(echo $AWS_CREDS | jq '.')"
            exit 1
          fi

          echo "VVV AWS credentials retrieved from Vault"
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
          echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV

      # -------------------------
      # Configure AWS using official action
      # -------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Get Terraform outputs
        id: terraform
        working-directory: terraform
        run: |
          echo "instance_ip=$(terraform output -raw instance_public_ip)" >> $GITHUB_OUTPUT
          echo "ssh_key_path=$(terraform output -raw ssh_private_key_path)" >> $GITHUB_OUTPUT

      - name: Wait for EC2 to be ready
        run: |
          echo "Waiting for SSH on ${{ steps.terraform.outputs.instance_ip }}..."
          for i in {1..30}; do
            if nc -z ${{ steps.terraform.outputs.instance_ip }} 22 2>/dev/null; then
              echo "VVV SSH is ready!"
              exit 0
            fi
            echo "Attempt $i/30: Not ready yet, waiting 10s..."
            sleep 10
          done
          echo "XXX SSH not ready after 5 minutes"
          exit 1

      - name: Upload SSH key
        uses: actions/upload-artifact@v4
        with:
          name: ssh-key
          path: terraform/ec2-key.pem
          retention-days: 1

      - name: Upload Terraform state
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform/terraform.tfstate
          retention-days: 1

  # ==========================================
  # JOB 2 : CONFIGURE & DEPLOY
  # ==========================================
  configure:
    runs-on: ubuntu-latest
    needs: provision

    permissions:
      id-token: write
      contents: read

    env:
      VAULT_ADDR: ${{ vars.VAULT_ADDR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download SSH key
        uses: actions/download-artifact@v4
        with:
          name: ssh-key
          path: terraform/

      - name: Set SSH key permissions
        run: chmod 600 terraform/ec2-key.pem

      # -------------------------
      # Authenticate to Vault
      # -------------------------
      - name: Login to Vault with OIDC
        run: |
          sudo apt install -y jq curl

          JWT=$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/${{ github.repository_owner }}" \
            | jq -r '.value')

          VAULT_RESPONSE=$(curl -s \
            --request POST \
            --header "X-Vault-Namespace: admin" \
            --data "{\"jwt\":\"$JWT\",\"role\":\"github-actions\"}" \
            $VAULT_ADDR/v1/auth/jwt/login)

          VAULT_TOKEN=$(echo "$VAULT_RESPONSE" | jq -r '.auth.client_token')

          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "XXX Failed to authenticate to Vault"
            echo "Response: $(echo $VAULT_RESPONSE | jq '.')"
            exit 1
          fi

          echo "VVV Vault authentication successful"
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
          echo "VAULT_NAMESPACE=admin" >> $GITHUB_ENV

      # -------------------------
      # Read APP_SECRET from Vault
      # -------------------------
      - name: Read APP_SECRET from Vault
        run: |
          echo "Reading APP_SECRET from Vault..."

          APP_SECRET=$(curl -s \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "X-Vault-Namespace: $VAULT_NAMESPACE" \
            $VAULT_ADDR/v1/secret/data/iac/app \
            | jq -r '.data.data.app_secret')

          if [ -z "$APP_SECRET" ] || [ "$APP_SECRET" = "null" ]; then
            echo "XXX Failed to read APP_SECRET from Vault"
            exit 1
          fi

          echo "VVV APP_SECRET retrieved from Vault"
          echo "APP_SECRET=$APP_SECRET" >> $GITHUB_ENV

      - name: Generate Ansible inventory
        run: |
          mkdir -p ansible/inventory
          cat > ansible/inventory/hosts.ini <<EOF
          [servers]
          ec2 ansible_host=${{ needs.provision.outputs.instance_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=../terraform/ec2-key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

          cat ansible/inventory/hosts.ini

      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible

      - name: Run Ansible Playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          cd ansible
          ansible-playbook \
            -i inventory/hosts.ini \
            --extra-vars "app_secret=${APP_SECRET}" \
            playbook.yml

      - name: Test application
        run: |
          echo "Testing app at http://${{ needs.provision.outputs.instance_ip }}:5000"
          echo "Waiting for Docker container to start..."
          sleep 30

          for i in {1..5}; do
            echo "Attempt $i/5..."
            if curl -f http://${{ needs.provision.outputs.instance_ip }}:5000; then
              echo "VVV Application is running!"
              exit 0
            fi
            echo "Not ready yet, waiting 10s..."
            sleep 10
          done

          echo "XXX Application failed to start"
          exit 1

      - name: Display application URL
        run: |
          echo "!!! Application deployed successfully!"
          echo "Access it at: http://${{ needs.provision.outputs.instance_ip }}:5000"
          echo ""
          echo " The APP_SECRET from Vault should be visible on the page"

  # ==========================================
  # JOB 3 : CLEANUP
  # ==========================================
  cleanup:
    runs-on: ubuntu-latest
    needs: [provision, configure]
    if: always()

    permissions:
      id-token: write
      contents: read

    env:
      VAULT_ADDR: ${{ vars.VAULT_ADDR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------------
      # Authenticate to Vault
      # -------------------------
      - name: Login to Vault with OIDC
        run: |
          sudo apt install -y jq curl

          JWT=$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/${{ github.repository_owner }}" \
            | jq -r '.value')

          VAULT_RESPONSE=$(curl -s \
            --request POST \
            --header "X-Vault-Namespace: admin" \
            --data "{\"jwt\":\"$JWT\",\"role\":\"github-actions\"}" \
            $VAULT_ADDR/v1/auth/jwt/login)

          VAULT_TOKEN=$(echo "$VAULT_RESPONSE" | jq -r '.auth.client_token')

          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "XXX Failed to authenticate to Vault"
            echo "Response: $(echo $VAULT_RESPONSE | jq '.')"
            exit 1
          fi

          echo "VVV Vault authentication successful"
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
          echo "VAULT_NAMESPACE=admin" >> $GITHUB_ENV

      # -------------------------
      # Read AWS credentials from Vault
      # -------------------------
      - name: Read AWS credentials from Vault
        run: |
          echo "Reading AWS credentials from Vault..."

          AWS_CREDS=$(curl -s \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "X-Vault-Namespace: $VAULT_NAMESPACE" \
            $VAULT_ADDR/v1/secret/data/iac/aws)

          AWS_ACCESS_KEY_ID=$(echo $AWS_CREDS | jq -r '.data.data.access_key_id')
          AWS_SECRET_ACCESS_KEY=$(echo $AWS_CREDS | jq -r '.data.data.secret_access_key')
          AWS_REGION=$(echo $AWS_CREDS | jq -r '.data.data.region')

          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ "$AWS_ACCESS_KEY_ID" = "null" ]; then
            echo "XXX Failed to read AWS credentials from Vault"
            echo "Response: $(echo $AWS_CREDS | jq '.')"
            exit 1
          fi

          echo "VVV AWS credentials retrieved from Vault"
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
          echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV

      # -------------------------
      # Configure AWS using official action
      # -------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Terraform state
        uses: actions/download-artifact@v4
        with:
          name: terraform-state
          path: terraform/
        continue-on-error: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Destroy
        working-directory: terraform
        run: terraform destroy -auto-approve
